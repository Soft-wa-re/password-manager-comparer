// Copyright from the original work from which this is derived:
//
// Copyright (c) 2018-2019 Quantopian Inc.
//
// Quantopian grants you the right to reuse this code in any private or public
// context, in modified or unmodified form, as long as this copyright notice is
// left intact and the table generated by this code (or your modified version
// of it) is preceded or followed by a visible credit to "Jonathan Kamens of
// Quantopian Inc." which links to
// https://medium.com/@QuantopianCyber/head-to-head-evaluation-of-five-password-managers-8faa4851c767 .
//
// If you add any additional features and/or products to the comparison grid or
// correct any errors or omissions, you are encouraged to submit your
// improvements back to security@quantopian.com so we can incorporate them into
// the original, published version of the grid for the benefit of other readers.
//
// Copyright for this derivative work:
//
// Copyright (c) 2019 Jonathan Kamens
//
// You can do whatever you want with this code provided that you leave this
// entire copyright block intact, credit me, and link back to
// https://blog.kamens.us/?p=5729.

// eslint-disable-next-line no-unused-vars, import/extensions
import { React, ReactDOM, html } from './deps.js';
// eslint-disable-next-line import/extensions
import { rawData, notes } from './data.js';

const dataTags = [];
// eslint-disable-next-line no-plusplus
for (let i = 1; i < rawData.length; i++) {
  const tags = rawData[i][1];
  // eslint-disable-next-line no-plusplus
  for (let j = 0; j < tags.length; j++) { if (!dataTags.includes(tags[j])) dataTags.push(tags[j]); }
  dataTags.sort();
}

function yesNoCompare(n1, v1, n2, v2) {
  // eslint-disable-next-line eqeqeq
  if (v1 == v2) return 'tie';
  // eslint-disable-next-line eqeqeq
  if (v1 == 'yes') return n1;
  // eslint-disable-next-line eqeqeq
  if (v2 == 'yes') return n2;
  // eslint-disable-next-line eqeqeq
  if (v1 == 'no') return n2;
  // eslint-disable-next-line eqeqeq
  if (v2 == 'no') return n1;
  return 'tie';
}

function getValue(v) {
  if (Array.isArray(v)) { return v[0]; }
  return v;
}

function formatValue(v) {
  // eslint-disable-next-line no-param-reassign
  v = getValue(v);
  // eslint-disable-next-line eqeqeq
  if (v + 0 == v) return v;
  // eslint-disable-next-line eqeqeq
  if (v == 'yes') return `<span style='color: #0D8050'>${v}</span>`;
  // eslint-disable-next-line eqeqeq
  if (v == 'no') return `<span style='color: #C23030'>${v}</span>`;
  return `<span style='color: #BF7326;'>${v}</span>`;
}

window.formatNotes = function formatNotes(v, current, mappings) {
  if (!Array.isArray(v)) { return ''; }
  const foundNotes = [];
  // eslint-disable-next-line no-plusplus
  for (let i = 1; i < v.length; i++) {
    if (!mappings[v[i]]) {
      // eslint-disable-next-line prefer-destructuring, no-param-reassign
      mappings[v[i]] = current[0];
      // eslint-disable-next-line no-plusplus, no-param-reassign
      current[0]++;
    }
    if (mappings[v[i]]) {
      foundNotes.push(`<sup>${v[i]}</sup>`);
    }
  }
  return foundNotes.join(',');
}

window.formatTable = function formatTable() {
  // eslint-disable-next-line no-unused-vars
  let compare1;
  // eslint-disable-next-line no-unused-vars
  let compare2;
  const currentNote = [1];
  const noteMappings = {};

  try {
    window.compare1 = document.getElementById('compare1').value;
    window.compare2 = document.getElementById('compare2').value;
  } catch {
    // First time page is loaded.
  }
  // eslint-disable-next-line prefer-destructuring
  window.products = rawData[0][2];
  let comparing; let index1; let index2; let score1; let
    score2;
  if (window.compare1 && window.compare2) {
    comparing = true;
    // eslint-disable-next-line no-multi-assign
    score1 = score2 = 0;
    // eslint-disable-next-line vars-on-top, no-var, block-scoped-var, no-plusplus
    for (var i = 0; i < window.products.length; i++) {
      // eslint-disable-next-line block-scoped-var, eqeqeq
      if (window.products[i] == window.compare1) index1 = i;
      // eslint-disable-next-line block-scoped-var, eqeqeq
      if (window.products[i] == window.compare2) index2 = i;
    }
  }

  let featureList = ``;

  window.wantFeatures = [];
  let table; 
  let scores = '';

  let t = "<div class='table-wrapper'><table class='table'>\n";

  t += makeHeader(comparing, t);
  // eslint-disable-next-line vars-on-top, no-var, no-redeclare, block-scoped-var, no-plusplus
  var i;
  ({ i, i, table, score1, score2, scores, t } = makeTable(i, table, currentNote, noteMappings, comparing, index1, index2, score1, score2, scores, t));

  t += '</table></div>\n';
  t += window.makeForm(featureList);
  t += makeNotes(currentNote, noteMappings);
  return t;
}

// eslint-disable-next-line func-names
window.changeTable = function () {
  // eslint-disable-next-line no-unused-vars
  const App = (props) => ({ __html: formatTable() });

  ReactDOM.render(
    html`<div dangerouslySetInnerHTML=${App()} />`,
    document.body,
  );
};

// eslint-disable-next-line func-names
window.onLoad = function () {
  // eslint-disable-next-line no-undef
  changeTable();
};

window.makeForm = function makeForm(featureList) {
  let form = `<form>
    <h1>Password Manager Comparison</h1>
    <a href='./contributors.html'>contributors</a>
    <p class='features'>
    <b>Toggle features you care about:</b>`;
  // eslint-disable-next-line vars-on-top, no-var, no-redeclare, block-scoped-var, no-plusplus
  for (var i = 0; i < dataTags.length; i++) {
    // eslint-disable-next-line block-scoped-var
    const feature = dataTags[i];
    // eslint-disable-next-line eqeqeq, no-continue
    if (feature == 'OR') continue;
    const id = `feature${feature}`;
    // eslint-disable-next-line vars-on-top, no-var
    var checked;
    try {
      checked = document.getElementById(id).checked;
    } catch {
      checked = true;
    }
    if (checked) window.wantFeatures.push(feature);
    featureList += " <span style='white-space: nowrap;'>"
      + `<input  class='form-check-input' type='checkbox' id='${id}'`;
    if (checked) featureList += ' checked';
    featureList += ` onchange='changeTable()'><label class="form-check-label" for='${id}'>${feature}</label></span>\n`;
  }
  featureList += '</p>';
  form += featureList;
  // eslint-disable-next-line func-names
  form += "<p class='compare'><b>Add a comparison:</b> Compare ";
  form += window.makeDropdown(1, window.compare2, window.compare1);
  form += ' to ';
  form += window.makeDropdown(2, window.compare1, window.compare2);
  form += '</p>\n';
  form += '</form>\n';
  return form;
}

window.makeDropdown = function (id, c1, c2) {
  let dd = '';
  // eslint-disable-next-line no-shadow, no-plusplus
  for (let i = 0; i < window.products.length; i++) {
    // eslint-disable-next-line eqeqeq, no-empty
    if (window.products[i] == c1) {
    } else {
      dd += `<option value='${window.products[i]}'
                  ${window.products[i] == c2 ? ' selected' : ''}
                > ${window.products[i]} </option>}`;
    }
  }
  return `
      <select class='d-inline-block w-auto form-select' aria-label='Default select example'  id='compare${id}' onchange='changeTable()'>
        <option value>(select)</option>
        ${dd}
      </select>
      `;
};

window.makeTable = function makeTable(i, table, currentNote, noteMappings, comparing, index1, index2, score1, score2, scores, t) {
  for (var i = 1; i < rawData.length; i++) {
    // eslint-disable-next-line block-scoped-var
    let tags = rawData[i][1];
    if (tags.length) {
      // eslint-disable-next-line vars-on-top, no-var
      var found;
      // eslint-disable-next-line eqeqeq
      if (tags[0] == 'OR') {
        tags = tags.slice(1);
        found = false;
        // eslint-disable-next-line vars-on-top, no-var, block-scoped-var, no-plusplus
        for (var j = 0; j < window.wantFeatures.length; j++) {
          // eslint-disable-next-line block-scoped-var
          if (tags.includes(window.wantFeatures[j])) {
            found = true;
            break;
          }
        }
      } else {
        found = true;
        // eslint-disable-next-line vars-on-top, no-var, no-redeclare, block-scoped-var, no-plusplus
        for (var j = 0; j < tags.length; j++) {
          // eslint-disable-next-line block-scoped-var
          if (!window.wantFeatures.includes(tags[j])) {
            found = false;
            break;
          }
        }
      }
      // eslint-disable-next-line no-continue
      if (!found)
        continue;
    }
    // eslint-disable-next-line block-scoped-var
    table += `<tr><td>${rawData[i][0]}</td>`;
    // eslint-disable-next-line block-scoped-var
    const values = rawData[i][2];
    // eslint-disable-next-line vars-on-top, no-var, no-redeclare, block-scoped-var, no-plusplus
    for (var j = 0; j < values.length; j++) {
      // eslint-disable-next-line block-scoped-var
      table += `<td>${formatValue(values[j])}
                ${formatNotes(values[j], currentNote, noteMappings)}</td>`;
    }
    if (comparing) {
      // eslint-disable-next-line vars-on-top, no-var
      var cmp;
      // eslint-disable-next-line prefer-destructuring, no-cond-assign, block-scoped-var
      if (!(cmp = rawData[i][3])) { cmp = yesNoCompare; }
      const winner = cmp(
        window.compare1,
        getValue(values[index1]),
        window.compare2,
        getValue(values[index2])
      );
      // eslint-disable-next-line eqeqeq, no-plusplus
      if (winner == window.compare1)
        score1++;

      // eslint-disable-next-line eqeqeq, no-plusplus
      else if (winner == window.compare2)
        score2++;
      table += `<td>${winner}</td>`;
    }
    table += '</tr>\n';
  }

  if (comparing) {
    scores += `
        <tr><th align=left colspan='${1 + window.products.length}'>Score:</th>
        <th align=left>
            ${window.compare1} - ${score1}<br/>
            ${window.compare2} - ${score2}</th></tr>`;
  }

  t += scores;
  t += table;
  return { i, i, table, score1, score2, scores, t };
}

window.makeHeader = function makeHeader(comparing) {
  return `
    <tr>
      <th>${rawData[0][0]}</th>
      ${window.products.reduce((p, c) => `${p}<th>${c}</th>`, '')}
      ${comparing ? `<th>${window.compare1} vs. ${window.compare2}</th>` : ''}
    </tr>`;
}

function makeNotes(currentNote, noteMappings) {
  let note = `<div class='notes'>
              <hr/>`;
  note += Object.keys(notes).reduce((prev, curr) => {
    return `${prev}<p><sup>${curr}</sup>${notes[curr]}</p>`;
  }, '')
  note += '</div>';
  return note;
}